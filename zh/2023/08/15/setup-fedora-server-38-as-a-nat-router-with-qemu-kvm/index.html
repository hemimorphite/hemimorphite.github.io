<!DOCTYPE html>
<html lang="en">
	<head>
		
		
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	    <meta name="description" content="This tutorial provides step-by-step instructions on how to set up Fedora Server 38 as a NAT router using Qemu/KVM. Learn how to configure network settings and create virtual machines to build your own virtual network infrastructure.">
	    <meta name="author" content="Samuel Yang">
	    <link rel="canonical" href="https://hemimorphite.github.io/zh/2023/08/15/setup-fedora-server-38-as-a-nat-router-with-qemu-kvm/">
	    <link rel="icon" type="image/x-icon" href="https://hemimorphite.github.io/zh/favicon.ico">
	    <meta property="fb:app_id" content="771418017802270">
		<meta property="og:title" content="Setup Fedora Server 38 as a NAT Router with Qemu/KVM, Part 1">
		<meta property="og:type" content="article">
		<meta property="og:site_name" content="Hemimorphite">
		<meta property="og:url" content="https://hemimorphite.github.io/zh/2023/08/15/setup-fedora-server-38-as-a-nat-router-with-qemu-kvm/">
		<meta property="og:description" content="This tutorial provides step-by-step instructions on how to set up Fedora Server 38 as a NAT router using Qemu/KVM. Learn how to configure network settings and create virtual machines to build your own virtual network infrastructure.">
		<meta property="og:image" content="https://hemimorphite.github.io/assets/images/fedora38.jpg">

		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="Setup Fedora Server 38 as a NAT Router with Qemu/KVM, Part 1">
		<meta name="twitter:description" content="This tutorial provides step-by-step instructions on how to set up Fedora Server 38 as a NAT router using Qemu/KVM. Learn how to configure network settings and create virtual machines to build your own virtual network infrastructure.">
		<meta name="twitter:creator" content="Samuel Yang">
		<meta name="twitter:image:src" content="https://hemimorphite.github.io/assets/images/fedora38.jpg">
	
	    <link href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i&display=swap" rel="stylesheet">

	    <title>Setup Fedora Server 38 as a NAT Router with Qemu/KVM, Part 1</title>

	    <!-- Bootstrap core CSS -->
	    <link rel="stylesheet" href="https://hemimorphite.github.io/assets/vendor/bootstrap/css/bootstrap.css">

	    <!-- Additional CSS Files -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
		<link rel="stylesheet" href="https://hemimorphite.github.io/assets/vendor/highlight.js/css/default.min.css">
	    <link rel="stylesheet" href="https://hemimorphite.github.io/assets/vendor/highlight.js/css/themes/monokai-sublime.css">
	    <link rel="stylesheet" href="https://hemimorphite.github.io/assets/css/fontawesome.css">
	    <link rel="stylesheet" href="https://hemimorphite.github.io/assets/css/hemimorphite.css">
  	</head>

  	<body>
  		<!-- ***** Preloader Start ***** -->
	    <!--<div id="preloader">
	        <div class="jumper">
	            <div></div>
	            <div></div>
	            <div></div>
	        </div>
	    </div>-->  
	    <!-- ***** Preloader End ***** -->
	    
	    <!-- Header -->
	    <header>
			<nav class="navbar navbar-expand-lg">
				<div class="container">
					<h2 class="navbar-brand"><a href="https://hemimorphite.github.io/zh/">Hemimorphite</a></h2>
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
						<span class="icon"></span>
					</button>
					<div class="collapse navbar-collapse" id="navbarResponsive">
						<ul class="navbar-nav ms-auto">
							<li class="nav-item ">
								<a class="nav-link" href="https://hemimorphite.github.io/zh/">Home
									
								</a>
							</li>
						
						
						
						

						
						
						

						
						  	
						  	<li class="nav-item ">
								<a class="nav-link" href="https://hemimorphite.github.io/zh/about">About
									
								</a>
							</li>
						  	
						  	
						
						
						

						
						
						

						
						
						

						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						

						
						  	
						  	
						
						
						</ul>
					</div>
				</div>
			</nav>
	    </header>
	    
		<section>
			<div class="container">
				<div class="row">
					<div class="col-12">
						<script type="text/javascript">
							atOptions = {
								'key' : '9cf40e8a46ab80f525196d3376630858',
								'format' : 'iframe',
								'height' : 90,
								'width' : 728,
								'params' : {}
							};
						</script>
						<script type="text/javascript" src="//www.topcreativeformat.com/9cf40e8a46ab80f525196d3376630858/invoke.js"></script>
					</div>
				</div>
			</div>
		</section>

	    <!-- Page Content -->
<section>
	<div class="container">
		<div class="row">
			<div class="col-12">
				<script type="text/javascript">
					atOptions = {
						'key' : '9cf40e8a46ab80f525196d3376630858',
						'format' : 'iframe',
						'height' : 90,
						'width' : 728,
						'params' : {}
					};
				</script>
				<script type="text/javascript" src="//www.topcreativeformat.com/9cf40e8a46ab80f525196d3376630858/invoke.js"></script>
			</div>
			<div class="col-lg-2">
				<a href="https://hemimorphite.github.io/zh/" type="button" class="btn btn-all ms-auto"><i class="fa-solid fa-arrow-left"></i> All posts</a>

				<div>
					<script type="text/javascript">
						atOptions = {
							'key' : '038e6b1f96b2e2f8ee26abfaebf2b477',
							'format' : 'iframe',
							'height' : 300,
							'width' : 160,
							'params' : {}
						};
					</script>
					<script type="text/javascript" src="//www.topcreativeformat.com/038e6b1f96b2e2f8ee26abfaebf2b477/invoke.js"></script>
				</div>
				<div>
					<script type="text/javascript">
						atOptions = {
							'key' : '49182664b5d567ebee9725d9737c0006',
							'format' : 'iframe',
							'height' : 600,
							'width' : 160,
							'params' : {}
						};
					</script>
					<script type="text/javascript" src="//www.topcreativeformat.com/49182664b5d567ebee9725d9737c0006/invoke.js"></script>
				</div>
				<div>
					<script type="text/javascript">
						atOptions = {
							'key' : '038e6b1f96b2e2f8ee26abfaebf2b477',
							'format' : 'iframe',
							'height' : 300,
							'width' : 160,
							'params' : {}
						};
					</script>
					<script type="text/javascript" src="//www.topcreativeformat.com/038e6b1f96b2e2f8ee26abfaebf2b477/invoke.js"></script>
				</div>
				<div>
					<script type="text/javascript">
						atOptions = {
							'key' : '49182664b5d567ebee9725d9737c0006',
							'format' : 'iframe',
							'height' : 600,
							'width' : 160,
							'params' : {}
						};
					</script>
					<script type="text/javascript" src="//www.topcreativeformat.com/49182664b5d567ebee9725d9737c0006/invoke.js"></script>
				</div>
			</div>
			<div class="col-lg-10">
				<div class="blog-post">
    <h2 class="post-title">Setup Fedora Server 38 as a NAT Router with Qemu/KVM, Part 1</h2>
<div class="post-author">
    <span class="avatar"></span>
    <span class="info"><span class="date">Published August 15, 2023</span><br><span class="name">By Samuel Yang</span></span>
</div>

<figure class="post-image">
    <img src="/assets/images/fedora38.jpg" alt="Blog Cover">
</figure>

    <article class="post-content">
        <p>Welcome to configuring Fedora Server 38 as a router tutorial series!</p>

        <ol>
            <li><a href="https://hemimorphite.github.io/zh/2023/08/15/setup-fedora-server-38-as-a-nat-router-with-qemu-kvm/">Setup Fedora Server 38 as a NAT Router with Qemu/KVM, Part 1</a></li>
            <li><a href="https://hemimorphite.github.io/zh/2023/08/16/setup-fedora-server-38-as-a-dhcp-server/">Setup Fedora Server 38 as a DHCP Server with Qemu/KVM, Part 2</a></li>
            <li><a href="https://hemimorphite.github.io/zh/2023/08/16/setup-fedora-server-38-as-a-dns-server/">Setup Fedora Server 38 as a DNS Server with Qemu/KVM, Part 3</a></li>
        </ol>

        <p>This is how it will look like the virtual network we are going to build:</p>
        
        <figure class="post-figure">
            <img src="/assets/images/fedoranat-01.jpg" alt="configuring Fedora Server 38 as a NAT router">
        </figure>

        <ul>
            <li><b>enp0s4</b>: WAN interface</li>
            <li><b>enp0s5</b>: LAN interface with a ipv4 subnet prefix address 172.16.0.0/24</li>
            <li><b>192.168.0.15</b>: the first IPv4 address of Fedora Server 38 as WAN IPv4 address</li>
            <li><b>172.16.0.1</b>: the second IPv4 address of Fedora Server 38 as LAN IPv4 Gateway</li>
            <li><b>172.16.0.11</b>: the IPv4 address of the first client</li>
            <li><b>172.16.0.12</b>: the IPv4 address of the second client</li>
        </ul>

        <p>First, we need to have three qemu images:</p>

        <ul>
            <li>Fedora Server 38 distro as a router gateway</li>
            <li>Fedora Desktop 38 distro as a client 1</li>
            <li>Fedora Desktop 38 distro as a client 2</li>
        </ul>

        <p>Then, we need set up a linux bridge (which will act as a layer 2 switch) and three tap interfaces on the host computer to connect three qemu images to each other.</p>

        <p>We can create a new tap interface using <code>tunctl</code> command. In order to use <code>tunctl</code> command, you need to install <code>uml-utilities</code> package on Ubuntu:</p>

        <pre><code class="language-bash hljs">sudo apt install uml-utilities</code></pre>

        <p>Or <code>tunctl</code> package on Fedora:</p>

        <pre><code class="language-bash hljs">sudo dnf install tunctl</code></pre>

        <p>We need to create a tap interface for each of the virtual machines, then we will need to create three different tap interfaces:</p>

        <pre><code class="language-bash hljs">sudo tunctl -u $USER -t tap1
sudo tunctl -u $USER -t tap2
sudo tunctl -u $USER -t tap3</code></pre>

        <p>Next, we bring the tap interfaces up:</p>

        <pre><code class="language-bash hljs">sudo ip link set dev tap1 up 
sudo ip link set dev tap2 up
sudo ip link set dev tap3 up</code></pre>
        
        <p>Then, we create a network bridge using <code>brctl</code> command:</p>

        <pre><code class="language-bash hljs">sudo brctl addbr br0</code></pre>

        <p>Bring up the network bridge:</p>

        <pre><code class="language-bash hljs">sudo ip link set dev br0 up</code></pre>

        <p>Then we attach the tap interfaces to the bridge interface:</p>

        <pre><code class="language-bash hljs">sudo brctl addif br0 tap1
sudo brctl addif br0 tap2
sudo brctl addif br0 tap3</code></pre>
        
        <p>Start the Fedora Server 38 virtual machine by specifying two network interfaces (WAN interface and LAN interface) with unique mac addresses:</p>
        
        <pre><code class="language-bash hljs">qemu-system-x86_64 -name "Fedora Server 38 Router" \
-machine type=pc-q35-2.12 -accel kvm \
-m 4G -cpu host \
-display sdl \
-bios /usr/share/ovmf/OVMF.fd \
-device virtio-vga,addr=01.0 \
-drive file=fedorarouter.img,if=none,id=drive0 \
-device nvme,serial=364740043439,addr=02.0,bus=pcie.0,drive=drive0 \
-netdev user,id=net0,ipv4=on,net=192.168.0.0/24,ipv6=on,ipv6-net=fd65:9513:8ed6:5dc7::/64,dns=192.168.0.1,ipv6-dns=fd65:9513:8ed6:5dc7::1 \
-device e1000-82545em,addr=04.0,bus=pcie.0,mac=46:34:84:53:93:78,netdev=net0 \
-netdev tap,id=net1,ifname="tap1",script=no,downscript=no \
-device e1000-82545em,addr=05.0,bus=pcie.0,mac=35:93:59:28:34:55,netdev=net1</code></pre>
        
        <p>List all the available devices/network interfaces using <code>nmcli</code> command:</p>

        <pre><code class="language-bash hljs">sudo nmcli device status</code></pre>

        <p>The response should look similar to this:</p>

        <pre><code class="language-bash hljs">enp0s4  ethernet  connected               enp0s4     
lo      loopback  connected (externally)  lo         
enp0s5  ethernet  disconnected            --</code></pre>
        
        <p>WAN interface <code>enp0s4</code> sets to DHCP and LAN interface <code>enp0s5</code> sets to static IP.</p>

        <p>Create a LAN interface connection <code>enp0s5</code>:</p>

        <pre><code class="language-bash hljs">sudo nmcli connection add type ethernet con-name enp0s5</code></pre>

        <p>Attach the <code>enp0s5</code> device to the connection <code>enp0s5</code>:</p>
        
        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s5 connection.interface-name enp0s5</code></pre>

        <p>Modify the connection <code>enp0s5</code> to use a static IP.</p>

        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s5 ipv4.addresses 172.16.0.1/24
sudo nmcli connection modify enp0s5 ipv6.addresses fd62:bf06:3a25:7670::1/64</code></pre>
        
sudo nmcli connection modify enp0s6 ipv4.addresses 172.17.0.1/24
sudo nmcli connection modify enp0s6 ipv6.addresses fdf4:1106:0655:089f::1/64

        <p>Then, change the connection addressing method from <code>auto</code> to <code>manual</code>.</p>
        
        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s5 ipv4.method manual
sudo nmcli connection modify enp0s5 ipv6.method manual</code></pre>
        
        <p>To apply the configuration, run:</p>

        <pre><code class="language-bash hljs">sudo systemctl restart NetworkManager</code></pre>

        <p>Next, we need to enable IP Masquerading. The purpose of IP Masquerading is to allow machines with private IP addresses on your network to access the Internet through the machine doing the masquerading.</p>

        <p>To enable IP Masquerading in firewalld, run:</p>
        
        <pre><code class="language-bash hljs">sudo firewall-cmd --zone=public --permanent --add-masquerade</code></pre>

        <p>IP forwarding plays a fundamental role on a router. This is the functionality that allows a router to forward traffic from one network interface to another network interface.</p>

        <p>To enable IP forwarding in firewalld, run:</p>
        
        <pre><code class="language-bash hljs">sudo firewall-cmd --zone=public --permanent --add-forward</code></pre>    

        <p>To apply the configuration, run:</p>

        <pre><code class="language-bash hljs">sudo firewall-cmd --reload</code></pre>

        <p>Then, we also need to IP forwarding on the Fedora Server system by creating sysctl configuration file <code>90-override.conf</code> in <code>/etc/sysctl.d/</code> and add the following line:.</p>        

        <pre><code class="language-bash hljs">net.ipv4.ip_forward=1

net.ipv6.conf.default.forwarding=1</code></pre>        

        <p>Next, execute the <code>sysctl</code> command to enable the new settings in the configuration file:</p>

        <pre><code class="language-bash hljs">sysctl -p /etc/sysctl.d/90-override.conf</code></pre>

        <!--<p>Dynamic Host Configuration Protocol or DHCP is an IP network protocol that relies on client-server architecture to automatically set IP addresses and other attributes to an IP host to enable information transfer between network nodes.</p>

        <p>DHCPv4 servers have a UDP port number of 67, so listen for messages addressed to this port number. On the other hand, DHCPv4 clients have the UDP port number 68 and only respond to messages sent to number 68.</p>

        <p>DHCPv4 and DHCPv6 UDP port numbers are different. DHCPv6 servers have a UDP port number of 547 and DHCPv6 clients have the UDP port number 546.</p>

        <p>In order to enable communication between the built-in DHCPv4 server of <code>systemd-networkd</code> on UDP port 67 and the built-in DHCPv4 client of <code>systemd-networkd</code> on UDP port 68, you need to open UDP port 67 in ufw:</p>

        <pre><code class="language-bash hljs">sudo firewall-cmd --zone=public --permanent --add-port=67/udp</code></pre>

        <p>The same as DHCPv6 server of <code>systemd-networkd</code> on UDP port 547 and the built-in DHCPv6 client of <code>systemd-networkd</code> on UDP port 546, you need to open UDP port 547 in ufw:</p>

        <pre><code class="language-bash hljs">sudo firewall-cmd --zone=public --permanent --add-port=547/udp</code></pre>-->

        <p>Start the Ubuntu Desktop 22.04 virtual machines by specifying one network interface (only LAN interface) with unique mac addresses:</p>

        <pre><code class="language-bash hljs">qemu-system-x86_64 -name "Fedora Desktop 38 Client 1" \
-machine type=pc-q35-2.12 -accel kvm \
-m 4G -cpu host \
-display sdl \
-bios /usr/share/ovmf/OVMF.fd \
-device virtio-vga,addr=01.0 \
-drive file=fedoraclient1.img,if=none,id=drive0 \
-device nvme,serial=364740043439,addr=02.0,bus=pcie.0,drive=drive0 \
-netdev tap,id=net0,ifname="tap2",script=no,downscript=no \
-device e1000-82545em,addr=04.0,bus=pcie.0,mac=68:98:35:90:34:56,netdev=net0</code></pre>
        
        <pre><code class="language-bash hljs">qemu-system-x86_64 -name "Fedora Desktop 38 Client 2" \
-machine type=pc-q35-2.12 -accel kvm \
-m 4G -cpu host \
-display sdl \
-bios /usr/share/ovmf/OVMF.fd \
-device virtio-vga,addr=01.0 \
-drive file=fedoraclient2.img,if=none,id=drive0 \
-device nvme,serial=364740043439,addr=02.0,bus=pcie.0,drive=drive0 \
-netdev tap,id=net0,ifname="tap3",script=no,downscript=no \
-device e1000-82545em,addr=04.0,bus=pcie.0,mac=82:54:65:76:38:28,netdev=net0</code></pre>
        
        <p>List all the available devices/network interfaces using <code>nmcli</code> command:</p>

        <pre><code class="language-bash hljs">sudo nmcli device status</code></pre>

        <p>The response should look similar to this:</p>

        <pre><code class="language-bash hljs">lo      loopback  connected (externally)  lo         
enp0s4  ethernet  disconnected            --</code></pre>
        
        <p>Create a LAN interface connection <code>enp0s4</code>:</p>

        <pre><code class="language-bash hljs">sudo nmcli connection add type ethernet con-name enp0s4</code></pre>

        <p>Attach the <code>enp0s4</code> device to the connection <code>enp0s4</code>:</p>
        
        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s4 connection.interface-name enp0s4</code></pre>

        <p>On the first client:</p>

        <p>Modify the connection <code>enp0s4</code> to use a static IP.</p>

        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s4 ipv4.addresses 172.16.0.11/24
sudo nmcli connection modify enp0s4 ipv6.addresses fd62:bf06:3a25:7670::11/64</code></pre>
        
        <p>Configure the default gateway.</p>

        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s4 ipv4.gateway 172.16.0.1
sudo nmcli connection modify enp0s4 ipv6.gateway fd62:bf06:3a25:7670::1</code></pre>

        <p>Then, change the connection addressing method from <code>auto</code> to <code>manual</code>.</p>
        
        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s4 ipv4.method manual
sudo nmcli connection modify enp0s4 ipv6.method manual</code></pre>
        
        <p>To apply the configuration, run:</p>

        <pre><code class="language-bash hljs">sudo systemctl restart NetworkManager</code></pre>

        <p>On the second client:</p>

        <p>Modify the connection <code>enp0s4</code> to use a static IP.</p>

        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s4 ipv4.addresses 172.16.0.12/24
sudo nmcli connection mod enp0s4 ipv6.addresses fd62:bf06:3a25:7670::12/64</code></pre>
        
        <p>Configure the default gateway.</p>

        <pre><code class="language-bash hljs">sudo nmcli connection modify enp0s4 ipv4.gateway 172.16.0.1
sudo nmcli connection mod enp0s4 ipv6.addresses fd62:bf06:3a25:7670::1</code></pre>

        <p>Then, change the connection addressing method from <code>auto</code> to <code>manual</code>.</p>
        
        <pre><code class="language-bash hljs">sudo nmcli connection mod enp0s4 ipv4.method manual
sudo nmcli connection mod enp0s4 ipv6.method manual</code></pre>

        <p>To apply the configuration, run:</p>

        <pre><code class="language-bash hljs">sudo systemctl restart NetworkManager</code></pre>        
        
        <p>Configure <code>systemd-resolved</code> to use Google Public DNS so your system can have internet access. Edit <code>/etc/systemd/resolved.conf</code>, uncomment and change the <code>DNS</code> to <code>8.8.8.8</code></p>

        <pre><code class="language-bash hljs">DNS=8.8.8.8</code></pre>        

        <p>To apply the configuration, run:</p>

        <pre><code class="language-bash hljs">sudo systemctl restart systemd-resolved</code></pre>

        <p>Try to ping google.com to check internet connectivity. You should have internet access now.</p>
    </article>

    <div class="post-tags">
	<div class="title">Tags</div>
	<ul class="tags">
		
		<li><a href="https://hemimorphite.github.io/zh/tag/qemu" class="tag">qemu</a></li>
		
		<li><a href="https://hemimorphite.github.io/zh/tag/linux" class="tag">linux</a></li>
		
		<li><a href="https://hemimorphite.github.io/zh/tag/fedora-38" class="tag">fedora 38</a></li>
		
		<li><a href="https://hemimorphite.github.io/zh/tag/firewalld" class="tag">firewalld</a></li>
		
		<li><a href="https://hemimorphite.github.io/zh/tag/nat" class="tag">NAT</a></li>
		
	</ul>
</div>


    <div class="post-share">
    <div class="title">Share this post</div>
    <ul class="rounded-social-buttons">
        <li><a href="https://www.facebook.com/sharer/sharer.php?u=https://hemimorphite.github.io/2023/08/16/setup-fedora-server-38-as-a-dhcp-server/" class="social-button facebook"><i class="fab fa-facebook-f"></i></a></li>
        <li><a href="http://twitter.com/share?text=Hey+guys%2c+check+this+out!&amp;url=https://hemimorphite.github.io/2023/08/16/setup-fedora-server-38-as-a-dhcp-server/&amp;hashtags=qemu,linux,fedora 38,firewalld,DHCP" class="social-button twitter"><i class="fab fa-twitter"></i></a></li>
        <li><a href="https://www.linkedin.com/sharing/share-offsite/?url=https://hemimorphite.github.io/2023/08/16/setup-fedora-server-38-as-a-dhcp-server/" class="social-button linkedin"><i class="fab fa-linkedin"></i></a></li>
    </ul>
</div>
</div>

				<div class="container">
					<div class="row">
						<div class="col-md-6">
							<script type="text/javascript">
								atOptions = {
									'key' : '24dfaf1e2babad270db4c0eae11415cc',
									'format' : 'iframe',
									'height' : 60,
									'width' : 468,
									'params' : {}
								};
							</script>
							<script type="text/javascript" src="//www.topcreativeformat.com/24dfaf1e2babad270db4c0eae11415cc/invoke.js"></script>
						</div>
						<div class="col-md-6">
							<script type="text/javascript">
								atOptions = {
									'key' : '24dfaf1e2babad270db4c0eae11415cc',
									'format' : 'iframe',
									'height' : 60,
									'width' : 468,
									'params' : {}
								};
							</script>
							<script type="text/javascript" src="//www.topcreativeformat.com/24dfaf1e2babad270db4c0eae11415cc/invoke.js"></script>
						</div>
						<div class="col-md-6">
							<script type="text/javascript">
								atOptions = {
									'key' : '08760f2487e830ed5039902de4007bec',
									'format' : 'iframe',
									'height' : 250,
									'width' : 300,
									'params' : {}
								};
							</script>
							<script type="text/javascript" src="//www.topcreativeformat.com/08760f2487e830ed5039902de4007bec/invoke.js"></script>
						</div>
						<div class="col-md-6">
							<script type="text/javascript">
								atOptions = {
									'key' : '08760f2487e830ed5039902de4007bec',
									'format' : 'iframe',
									'height' : 250,
									'width' : 300,
									'params' : {}
								};
							</script>
							<script type="text/javascript" src="//www.topcreativeformat.com/08760f2487e830ed5039902de4007bec/invoke.js"></script>
						</div>
					</div>
				</div>
				<div id="disqus_thread"></div>
			</div>

			<div class="col-12" style="border-bottom:0.1rem solid #eee;margin-top:2rem;margin-bottom:5rem;"></div>
		</div>
	</div>
</section>

<section>
	<div class="container">
		<div class="row">
			<div class="col-12">
				<div class="section-heading d-flex align-items-center">  
					<h2>Related Posts</h2>
					<a href="https://hemimorphite.github.io/zh/" type="button" class="btn btn-all ms-auto">All posts <i class="fa-solid fa-arrow-right"></i></a>
				</div>
				<div class="related-posts">
					<div class="row">
						
						
						
						
						
						
						<div class="col-md-6 col-lg-4">
							<div class="blog-post">
								<div class="blog-thumb">
									<a href="https://hemimorphite.github.io/zh/2023/08/16/setup-fedora-server-38-as-a-dns-server/"><img src="https://hemimorphite.github.io/assets/images/fedora38.jpg" alt=""></a>
								</div>
								<div class="blog-eyebrow">Tutorial</div>
								<h4 class="blog-title"><a href="https://hemimorphite.github.io/zh/2023/08/16/setup-fedora-server-38-as-a-dns-server/">Setup Fedora Server 38 as a DNS Server with Qemu/KVM, Part 3</a></h4>
							</div>
						</div>
						
						
						
						
						<div class="col-md-6 col-lg-4">
							<div class="blog-post">
								<div class="blog-thumb">
									<a href="https://hemimorphite.github.io/zh/2023/08/16/setup-fedora-server-38-as-a-dhcp-server/"><img src="https://hemimorphite.github.io/assets/images/fedora38.jpg" alt=""></a>
								</div>
								<div class="blog-eyebrow">Tutorial</div>
								<h4 class="blog-title"><a href="https://hemimorphite.github.io/zh/2023/08/16/setup-fedora-server-38-as-a-dhcp-server/">Setup Fedora Server 38 as a DHCP Server with Qemu/KVM, Part 2</a></h4>
							</div>
						</div>
						
						
						
						
						
						
						<div class="col-md-6 col-lg-4">
							<div class="blog-post">
								<div class="blog-thumb">
									<a href="https://hemimorphite.github.io/zh/2023/08/13/setup-ubuntu-server-22.04-as-a-dns-server/"><img src="https://hemimorphite.github.io/assets/images/ubuntu2204.jpg" alt=""></a>
								</div>
								<div class="blog-eyebrow">Tutorial</div>
								<h4 class="blog-title"><a href="https://hemimorphite.github.io/zh/2023/08/13/setup-ubuntu-server-22.04-as-a-dns-server/">Setup Ubuntu Server 22.04 as a DNS Server with Qemu/KVM, Part 3</a></h4>
							</div>
						</div>
						
						
						
						
						<div class="col-md-6 col-lg-4">
							<div class="blog-post">
								<div class="blog-thumb">
									<a href="https://hemimorphite.github.io/zh/2023/08/12/setup-ubuntu-server-22.04-as-a-dhcp-server/"><img src="https://hemimorphite.github.io/assets/images/ubuntu2204.jpg" alt=""></a>
								</div>
								<div class="blog-eyebrow">Tutorial</div>
								<h4 class="blog-title"><a href="https://hemimorphite.github.io/zh/2023/08/12/setup-ubuntu-server-22.04-as-a-dhcp-server/">Setup Ubuntu Server 22.04 as a DHCP Server with Qemu/KVM, Part 2</a></h4>
							</div>
						</div>
						
						
						
						
						<div class="col-md-6 col-lg-4">
							<div class="blog-post">
								<div class="blog-thumb">
									<a href="https://hemimorphite.github.io/zh/2023/08/08/setup-ubuntu-server-22-04-as-a-nat-router-with-qemu-kvm/"><img src="https://hemimorphite.github.io/assets/images/ubuntu2204.jpg" alt=""></a>
								</div>
								<div class="blog-eyebrow">Tutorial</div>
								<h4 class="blog-title"><a href="https://hemimorphite.github.io/zh/2023/08/08/setup-ubuntu-server-22-04-as-a-nat-router-with-qemu-kvm/">Setup Ubuntu Server 22.04 as a NAT Router with Qemu/KVM, Part 1</a></h4>
							</div>
						</div>
						
						
						
						
						<div class="col-md-6 col-lg-4">
							<div class="blog-post">
								<div class="blog-thumb">
									<a href="https://hemimorphite.github.io/zh/2023/07/31/getting-started-with-qemu-on-ubuntu-22.04/"><img src="https://hemimorphite.github.io/assets/images/qemu.jpg" alt=""></a>
								</div>
								<div class="blog-eyebrow">Tutorial</div>
								<h4 class="blog-title"><a href="https://hemimorphite.github.io/zh/2023/07/31/getting-started-with-qemu-on-ubuntu-22.04/">Getting Started with Qemu amd64 on Ubuntu 22.04</a></h4>
							</div>
						</div>
						
						
						
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

		<section>
			<div class="container">
				<div class="row">
					<div class="col-md-6">
						<script async="async" data-cfasync="false" src="//pl23622823.highrevenuenetwork.com/82849ac901fcdf553b99a113d233ce38/invoke.js"></script>
						<div id="container-82849ac901fcdf553b99a113d233ce38"></div>
					</div>
					<div class="col-md-6">
						<script type="text/javascript">
							atOptions = {
								'key' : '08760f2487e830ed5039902de4007bec',
								'format' : 'iframe',
								'height' : 250,
								'width' : 300,
								'params' : {}
							};
						</script>
						<script type="text/javascript" src="//www.topcreativeformat.com/08760f2487e830ed5039902de4007bec/invoke.js"></script>
					</div>
				</div>
			</div>
		</section>

	    <footer>
			<div class="container">
				<div class="row">
					<div class="col-lg-12">
						<div class="copyright-text">
						<p>&copy; 2024 Copyright hemimorphite. All Rights Reserved</p>
						</div>
					</div>
				</div>
			</div>
		</footer>

		<script src="https://hemimorphite.github.io/assets/vendor/jquery/jquery.min.js"></script>
	    <script src="https://hemimorphite.github.io/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	    <script src="https://hemimorphite.github.io/assets/vendor/highlight.js/js/highlight.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
	    <script>
			//<![CDATA[
			/* highlight.js | https://unpkg.com/highlightjs-badge@0.1.8/highlightjs-badge.min.js */
			"use strict";!function(e,o){"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?o(e,!0):function(e){if(!e.document)throw new Error("A window with a document is required");return o(e)}:o(e)}("undefined"!=typeof window?window:this,function(y,e){if("boolean"!=typeof o)var o=!1;function t(e){var o,m={templateSelector:"#CodeBadgeTemplate",contentSelector:"body",loadDelay:0,copyIconClass:"fa fa-copy",copyIconContent:"",checkIconClass:"fa fa-check text-success",checkIconContent:"",onBeforeCodeCopied:null};function t(){m.loadDelay?setTimeout(n,loadDelay):n()}function n(){if(!document.querySelector(m.templateSelector)){var e=document.createElement("div");e.innerHTML=function(){for(var e=["<style>","@media print {","   .code-badge { display: none; }","}","    .code-badge-pre {","        position: relative;","    }","    .code-badge {","        display: flex;","        flex-direction: row;","        white-space: normal;","        background: transparent;","        background: #fff;","        color: #333;","        font-size: 0.875em;","        opacity: 0.5;","        transition: opacity linear 0.5s;","        border-radius: 0 0 0 7px;","        padding: 5px 8px 5px 8px;","        position: absolute;","        right: 0;","        top: 0;","    }","    .code-badge.active {","        opacity: 0.8;","    }","","    .code-badge:hover {","        opacity: .95;","    }","","    .code-badge a,","    .code-badge a:hover {","        text-decoration: none;","    }","","    .code-badge-language {","        margin-right: 10px;","        font-weight: 600;","        color: goldenrod;","    }","    .code-badge-copy-icon {","        font-size: 1.2em;","        cursor: pointer;","        padding: 0 7px;","    }","    .fa.text-success:{ color: limegreen !important }","</style>",'<div id="CodeBadgeTemplate" style="display:none">','    <div class="code-badge">','        <div class="code-badge-language" ></div>','        <div  title="Copy to clipboard">','            <i class=" code-badge-copy-icon"></i></i></a>',"        </div>","     </div>","</div>"],o="",t=0;t<e.length;t++)o+=e[t]+"\n";return o}();var o=e.querySelector("style"),t=e.querySelector(m.templateSelector);document.body.appendChild(o),document.body.appendChild(t)}for(var n=document.querySelector(m.templateSelector).innerHTML,c=document.querySelectorAll("pre>code.hljs"),a=0;a<c.length;a++){var r=c[a];if(!r.querySelector(".code-badge")){for(var d="",l=0;l<r.classList.length;l++){var i=r.classList[l];if("language-"===i.substr(0,9)){d=r.classList[l].replace("language-","");break}if("lang-"===i.substr(0,5)){d=r.classList[l].replace("lang-","");break}if(!d)for(var s=0;s<r.classList.length;s++)if("hljs"!=r.classList[s]){d=r.classList[s];break}}"ps"==(d=d?d.toLowerCase():"text")?d="powershell":"cs"==d?d="csharp":"js"==d?d="javascript":"ts"==d?d="typescript":"fox"==d&&(d="foxpro");var p=n.replace("",d).replace("",m.copyIconClass).trim(),u=document.createElement("div");u.innerHTML=p,u=u.querySelector(".code-badge");var g=r.parentElement;g.classList.add("code-badge-pre"),m.copyIconContent&&(u.querySelector(".code-badge-copy-icon").innerText=m.copyIconContent),g.insertBefore(u,r)}}document.querySelector(m.contentSelector).addEventListener("click",function(e){return e.srcElement.classList.contains("code-badge-copy-icon")&&(e.preventDefault(),e.cancelBubble=!0,function(e){var o=e.srcElement.parentElement.parentElement.parentElement,t=o.querySelector("pre>code"),n=t.textContent||t.innerText;m.onBeforeCodeCopied&&(n=m.onBeforeCodeCopied(n,t));var c=document.createElement("textarea");c.value=n.trim(),document.body.appendChild(c),c.style.display="block",y.document.documentMode?c.setSelectionRange(0,c.value.length):c.select();document.execCommand("copy"),document.body.removeChild(c),function(e){var o=m.copyIconClass.split(" "),t=m.checkIconClass.split(" "),n=e.querySelector(".code-badge-copy-icon");n.innerText=m.checkIconContent;for(var c=0;c<o.length;c++)n.classList.remove(o[c]);for(c=0;c<t.length;c++)n.classList.add(t[c]);setTimeout(function(){n.innerText=m.copyIconContent;for(var e=0;e<t.length;e++)n.classList.remove(t[e]);for(e=0;e<o.length;e++)n.classList.add(o[e])},2e3)}(o)}(e)),!1})}o=e,Object.assign(m,o),"loading"==document.readyState?document.addEventListener("DOMContentLoaded",t):t()}y.highlightJsBadge=t,y.module&&y.module.exports&&(y.module.exports.highlightJsBadge=t),o&&t()});   
			//]]>
		</script>

	    <!-- Additional Scripts -->
	    <script src="https://hemimorphite.github.io/assets/js/custom.js"></script>
	    <script>
	    	let url = new URL("https://hemimorphite.github.io/zh/2023/08/15/setup-fedora-server-38-as-a-nat-router-with-qemu-kvm/");
			let paths = url.pathname.split('/').slice(1);

		    /**
		    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
		    if(typeof paths[3] !== 'undefined') {
		    	var disqus_config = function () {
				    this.page.url = "https://hemimorphite.github.io/zh/2023/08/15/setup-fedora-server-38-as-a-nat-router-with-qemu-kvm/";  // Replace PAGE_URL with your page's canonical URL variable
				    this.page.identifier = btoa(paths[3]); // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			    };
			    
			    (function() { // DON'T EDIT BELOW THIS LINE
			    var d = document, s = d.createElement('script');
			    s.src = 'https://hemimorphite-github-io.disqus.com/embed.js';
			    s.setAttribute('data-timestamp', +new Date());
			    (d.head || d.body).appendChild(s);
			    })();	
		    }
		    
		</script>
	    <script id="dsq-count-scr" src="https://hemimorphite-github-io.disqus.com/count.js" async></script>
		
  	</body>
</html>